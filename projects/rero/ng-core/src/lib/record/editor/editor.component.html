<!--
  RERO angular core
  Copyright (C) 2020-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<form [formGroup]="form" (ngSubmit)="submit()">
  <div class="core:grid core:grid-cols-12 core:gap-4">
    <div class="core:col-span-12 core:flex core:sticky core:z-10 core:top-0 core:bg-white core:h-full core:justify-between core:items-center core:border-b core:border-surface core:py-2">
      @if (rootField) {
        <legend>
            <span class="core:text-2xl" [pTooltip]="description" tooltipPosition="top">
              {{ title || recordType | ucfirst | translate }}
            </span>
        </legend>
      }
      <div class="core:flex core:items-center core:justify-end core:gap-1">
        <!-- load from template button -->
        @if (canLoadTemplate()) {
          <p-button
            id="editor-load-template-button"
            [label]="'Load templateâ€¦' | translate"
            [outlined]="true"
            icon="fa fa-upload"
            (onClick)="showLoadTemplateDialog()"
          />
        }
        <!-- cancel button -->
        <p-button
          id="editor-cancel-button"
          [label]="'Cancel' | translate"
          icon="fa fa-times"
          [outlined]="true"
          severity="danger"
          (onClick)="cancel()"
        />
      <!-- save button -->
        @if (saveAlternatives.length === 0) {
        <p-button
          id="editor-save-button"
          [label]="'Save' | translate"
          (onClick)="submit()"
          [disabled]="isSaveButtonDisabled"
        />
        } @else {
        <p-splitButton
          id="editor-save-button-split"
          [label]="'Save' | translate"
          (onClick)="submit()"
          [model]="saveAlternatives"
        />
        }
      </div>
    </div>

    <!-- add fields section -->
    @if (editorSettings.longMode) {
      <div class="core:col-span-2 bd-sidebar core:overflow-y-auto core:sticky core:pt-3">
        <ng-core-editor-add-field-editor [editorComponent]="editorComponent" />
      </div>
    }

    <!-- editor itself -->
    <div class="core:col-span-12" [ngClass]="{ 'core:col-span-10 core:lg:col-span-8': editorSettings.longMode }" role="main">
        <!-- ngx-formly -->
        <formly-form
          [model]="model"
          [fields]="fields"
          [options]="options"
          [form]="form"
          (modelChange)="modelChanged($event)"
        />
    </div>

    @if (editorSettings.longMode) {
      <!-- TOC navigation -->
      <nav class="core:col-span-2 core:pt-3 core:text-sm bd-toc core:sticky core:overflow-y-auto core:hidden core:lg:block" aria-label="Secondary navigation">
          <label for="addField" translate>Jump to</label>
          <ul class="core:ml-2 core:pl-0 core:list-none">
            @for (f of tocFields$ | async; track f) {
              <li class="core:mb-1">
                <span class="core:text-link-secondary core:cursor-pointer" (click)="setFocus($event, f)">{{ f.props.label | translate }}</span>
              </li>
            }
          </ul>
      </nav>
    }
  </div>
</form>

@if (error) {
  <ng-core-error [error]="error" />
}
