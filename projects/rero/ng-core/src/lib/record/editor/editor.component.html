<!--
  RERO angular core
  Copyright (C) 2020-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<form [formGroup]="form" (ngSubmit)="submit()">
  <div class="grid">
    <div class="col-12 flex header sticky top-0 bg-white h-full z-5 justify-content-between align-items-center my-2 p-2 border-bottom-1 surface-border">
      <div class="">
        @if (rootField) {
          <legend class="text-2xl">
              <span [pTooltip]="description" tooltipPosition="top">
                {{ title || recordType | ucfirst | translate }}
              </span>
          </legend>
        }
      </div>
      <div class="flex align-items-center justify-content-end gap-1">
        <!-- load from template button -->
        @if (canLoadTemplate()) {
          <p-button
            id="editor-load-template-button"
            [label]="'Load templateâ€¦' | translate"
            [outlined]="true"
            icon="fa fa-upload"
            (onClick)="showLoadTemplateDialog()"
          />
        }
        <!-- cancel button -->
        <p-button
          id="editor-cancel-button"
          [label]="'Cancel' | translate"
          icon="fa fa-times"
          [outlined]="true"
          severity="danger"
          (onClick)="cancel()"
        />
      <!-- save button -->
        @if (saveAlternatives.length === 0) {
        <p-button
          id="editor-save-button"
          [label]="'Save' | translate"
          (onClick)="submit()"
          [disabled]="isSaveButtonDisabled"
        />
        } @else {
        <p-splitButton
          id="editor-save-button-split"
          [label]="'Save' | translate"
          (onClick)="submit()"
          [model]="saveAlternatives"
        />
        }
      </div>
    </div>

    <!-- add fields section -->
    @if (editorSettings.longMode) {
      <div class="col-2 bd-sidebar overflow-y-auto sticky">
        <ng-core-editor-add-field-editor [editorComponent]="editorComponent" />
      </div>
    }

    <!-- editor itself -->
    <div class="col" [ngClass]="{ 'col-10 lg:col-8': editorSettings.longMode }" role="main">
        <!-- ngx-formly -->
        <formly-form
          [model]="model"
          [fields]="fields"
          [options]="options"
          [form]="form"
          (modelChange)="modelChanged($event)"
        />
    </div>

    @if (editorSettings.longMode) {
      <!-- TOC navigation -->
      <nav class="col-2 py-2 text-sm bd-toc sticky overflow-y-auto hidden lg:block" aria-label="Secondary navigation">
          <label for="addField" translate>Jump to</label>
          <ul class="ml-2 pl-0 list-none">
            @for (f of tocFields$ | async; track f) {
              <li class="mb-1">
                <span class="text-link-secondary" (click)="setFocus($event, f)">{{ f.props.label | translate }}</span>
              </li>
            }
          </ul>
      </nav>
    }
  </div>
</form>

@if (error) {
  <ng-core-error [error]="error" />
}
